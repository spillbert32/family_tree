<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Родовое древо с зумом и несколькими корнями</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      overflow: hidden;
    }
    svg {
      border: 1px solid #ccc;
      width: 100%;
      height: 900px;
      cursor: grab;
    }
    .node circle {
      stroke: steelblue;
      stroke-width: 3px;
    }
    .node text.name {
      font: 16px sans-serif;
      font-weight: bold;
      fill: #222;
    }
    .node text.dates {
      font: 13px sans-serif;
      fill: #666;
    }
    .link {
      fill: none;
      stroke: #999;
      stroke-width: 2px;
    }
    .spouse-link {
      stroke: #555;
      stroke-width: 1.5px;
      stroke-dasharray: 4 2;
    }
    .spouse-circle {
      stroke: #999;
      stroke-width: 2px;
      cursor: pointer;
    }
    .tooltip {
      position: absolute;
      background: #eee;
      padding: 4px 8px;
      border: 1px solid #666;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
      color: #222;
      visibility: hidden;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<h2>Родовое древо с зумом и несколькими корнями</h2>
<svg></svg>
<div id="tooltip" class="tooltip"></div>

<script>
  const svg = d3.select("svg");
  const width = +svg.node().clientWidth;
  const height = +svg.node().clientHeight;

  // Группа для всего дерева, к ней применим зум
  const svgGroup = svg.append("g").attr("transform", "translate(100, 50)");

  // Добавляем зум и панорамирование к SVG
  svg.call(d3.zoom()
    .scaleExtent([0.3, 3])
    .on("zoom", (event) => {
      svgGroup.attr("transform", event.transform);
    })
  );

  const tooltip = d3.select("#tooltip");

  const treeLayout = d3.tree().size([width - 200, height - 150]);

  function genderColor(gender) {
    if (gender === "male") return "#1f77b4";
    if (gender === "female") return "#e377c2";
    return "#ccc";
  }

  fetch('db.json')
    .then(response => response.json())
    .then(familyTreeData => {
      const personMap = new Map(familyTreeData.people.map(p => [p.id, p]));

      // Находим корней (у кого нет родителей)
      const roots = familyTreeData.people.filter(p => !p.parents || p.parents.length === 0);
      if (roots.length === 0) {
        console.error("Не найдено корневых предков");
        return;
      }

      const levelSeparationFactor = 2.5;
      const treeSpacingY = 550; // расстояние между деревьями по вертикали

      roots.forEach((root, index) => {
        // Рекурсивно строим иерархию для каждого корня
        function buildHierarchy(person) {
          const node = { ...person, children: [] };
          const children = familyTreeData.people.filter(p => p.parents?.includes(person.id));
          node.children = children.map(child => buildHierarchy(child));
          return node;
        }

        const treeRoot = buildHierarchy(root);
        const hierarchyData = d3.hierarchy(treeRoot);

        treeLayout(hierarchyData);

        hierarchyData.descendants().forEach(d => {
          d.x = d.x * levelSeparationFactor;
          d.y = d.y + index * treeSpacingY; // смещаем каждое дерево по вертикали
        });

        // Отрисовка линий связей (родители — дети)
        svgGroup.selectAll(`.link-root-${index}`)
          .data(hierarchyData.links())
          .join('path')
          .attr('class', `link link-root-${index}`)
          .attr('d', d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y));

        // Отрисовка узлов
        const node = svgGroup.selectAll(`.node-root-${index}`)
          .data(hierarchyData.descendants())
          .join('g')
          .attr('class', `node node-root-${index}`)
          .attr('transform', d => `translate(${d.x},${d.y})`);

        node.append('circle')
          .attr('r', 22)
          .attr('fill', d => genderColor(d.data.gender))
          .attr('stroke', 'steelblue')
          .attr('stroke-width', 3);

        node.append('text')
          .attr('class', 'name')
          .attr('dy', -12)
          .attr('y', d => d.children ? -30 : 30)
          .style('text-anchor', 'middle')
          .text(d => `${d.data.name || ""} ${d.data.surname || ""}`);

        node.append('text')
          .attr('class', 'dates')
          .attr('dy', 12)
          .attr('y', d => d.children ? -15 : 45)
          .style('text-anchor', 'middle')
          .text(d => {
            if (!d.data.birthYear) return "";
            return d.data.deathYear
              ? `${d.data.birthYear} - ${d.data.deathYear}`
              : `р. ${d.data.birthYear}`;
          });

        // Отрисовка супругов рядом с человеком
        node.each(function(d) {
          if (!d.data.spouses) return;

          const mainNode = d3.select(this);
          const spacing = 55;

          d.data.spouses.forEach((spouseId, i) => {
            const spouse = personMap.get(spouseId);
            if (!spouse) return;

            const spouseX = 22 + spacing + i * 45;
            const spouseY = 0;

            mainNode.append("line")
              .attr("class", "spouse-link")
              .attr("x1", 22)
              .attr("y1", 0)
              .attr("x2", spouseX - 12)
              .attr("y2", spouseY);

            mainNode.append("circle")
              .attr("class", "spouse-circle")
              .attr("r", 12)
              .attr("cx", spouseX)
              .attr("cy", spouseY)
              .attr("fill", genderColor(spouse.gender))
              .on("mousemove", (event) => {
                tooltip.style("visibility", "visible")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY - 20) + "px")
                  .text(`${spouse.name} ${spouse.surname} (${spouse.gender === "male" ? "муж" : "жена"})`);
              })
              .on("mouseout", () => tooltip.style("visibility", "hidden"));
          });
        });
      });
    })
    .catch(err => console.error("Ошибка загрузки db.json:", err));
</script>

</body>
</html>
